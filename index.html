<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Record App Final</title>

<style>
:root{
  --bg:#f2f2f7;
  --card:#fff;
  --text:#111;
  --sub:#6b7280;
  --border:#e5e7eb;
  --accent:#007aff;
  --ios-orange:#FF9F0A;
}
.dark{
  --bg:#0b1220;
  --card:#111827;
  --text:#e5e7eb;
  --border:#1f2937;
}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system}
.container{max-width:900px;margin:auto;padding:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:12px}
button{border:none;background:var(--accent);color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
.secondary{background:#9ca3af}
.area-bar{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap}
.area-btn{padding:6px 14px;border-radius:14px;border:1px solid var(--border);background:#f1f3f5;cursor:pointer}
.area-btn.active{background:var(--accent);color:#fff;border:none}
input,textarea{width:100%;padding:8px;border:1px solid var(--border);border-radius:10px;margin-bottom:6px;background:transparent;color:var(--text)}
.record{border:1px solid var(--border);border-radius:14px;padding:12px;margin-bottom:10px}
.group-title{font-size:13px;color:var(--sub);margin-top:8px;font-weight:600}
.record-field-name{color:var(--ios-orange);font-weight:600}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center}
.modal-box{background:#fff;padding:20px;border-radius:16px;width:280px}
</style>
</head>

<body>
<div class="container">

<button onclick="toggleDark()">ğŸŒ™ ë‹¤í¬ëª¨ë“œ</button>

<div class="area-bar" id="areaBar"></div>

<div class="card">
<b>ì˜ì—­ ê´€ë¦¬</b>
<input id="areaInput" placeholder="ì˜ì—­ ì´ë¦„">
<button onclick="addArea()">ì¶”ê°€</button>
<button class="secondary" onclick="updateArea()">ìˆ˜ì •</button>
<button class="secondary" onclick="deleteArea()">ì‚­ì œ</button>
</div>

<div class="card">
<b>í•„ë“œ ê·¸ë£¹ ê´€ë¦¬</b>
<input id="groupInput" placeholder="ê·¸ë£¹ ì´ë¦„">
<button onclick="addGroup()">ì¶”ê°€</button>
<button class="secondary" onclick="updateGroup()">ìˆ˜ì •</button>
<button class="secondary" onclick="deleteGroup()">ì‚­ì œ</button>
</div>

<div class="card">
<b>í•„ë“œ ê´€ë¦¬</b>
<input id="fieldInput" placeholder="í•„ë“œ ì´ë¦„">
<button onclick="addField()">ì¶”ê°€</button>
<button class="secondary" onclick="updateField()">ìˆ˜ì •</button>
<button class="secondary" onclick="deleteField()">ì‚­ì œ</button>
</div>

<div class="card" id="form"></div>
<div id="records"></div>

<div class="card">
<b>GitHub ë™ê¸°í™”</b>
<button onclick="openTokenModal()">í† í° ì…ë ¥</button>
<button onclick="upload()">ì—…ë¡œë“œ</button>
<button class="secondary" onclick="download()">ë‹¤ìš´ë¡œë“œ</button>
</div>

</div>

<div class="modal" id="tokenModal">
 <div class="modal-box">
  <b>GitHub Token</b>
  <input id="tokenInput" type="password">
  <button onclick="setToken()">í™•ì¸</button>
 </div>
</div>

<script>
const GITHUB={user:"apor76-cmyk",repo:"data",path:"data/dailycheck.json"};

let db=JSON.parse(localStorage.getItem("recordDB")||'{"areas":[]}');
let currentArea=null;
let editingRecord=null;
let token="";

const save=()=>localStorage.setItem("recordDB",JSON.stringify(db));

function toggleDark(){document.body.classList.toggle("dark")}
function openTokenModal(){tokenInput.value="";tokenModal.style.display="flex";}
function setToken(){token=tokenInput.value.trim();tokenInput.value="";tokenModal.style.display="none";}

/* AREA */
function addArea(){if(!areaInput.value)return;db.areas.push({id:Date.now(),name:areaInput.value,groups:[],records:[]});areaInput.value="";save();renderAreas();}
function selectArea(id){currentArea=db.areas.find(a=>a.id===id);areaInput.value=currentArea.name;renderAreas();renderForm();renderRecords();}
function updateArea(){if(currentArea&&areaInput.value){currentArea.name=areaInput.value;save();renderAreas();}}
function deleteArea(){if(!currentArea)return;db.areas=db.areas.filter(a=>a!==currentArea);currentArea=null;save();renderAreas();renderForm();renderRecords();}

/* GROUP */
function addGroup(){if(!currentArea||!groupInput.value)return;currentArea.groups.push({id:Date.now(),name:groupInput.value,fields:[]});groupInput.value="";save();renderForm();}
function updateGroup(){
 if(!currentArea||!groupInput.value)return;
 const g=currentArea.groups[currentArea.groups.length-1];
 if(g){g.name=groupInput.value;save();renderForm();}
}
function deleteGroup(){
 if(!currentArea)return;
 currentArea.groups.pop();
 save();renderForm();
}

/* FIELD */
function addField(){if(!currentArea||!fieldInput.value)return;currentArea.groups[currentArea.groups.length-1].fields.push({id:Date.now(),name:fieldInput.value});fieldInput.value="";save();renderForm();}
function updateField(){
 if(!currentArea||!fieldInput.value)return;
 const g=currentArea.groups[currentArea.groups.length-1];
 if(!g) return;
 const f=g.fields[g.fields.length-1];
 if(f){f.name=fieldInput.value;save();renderForm();}
}
function deleteField(){
 if(!currentArea)return;
 const g=currentArea.groups[currentArea.groups.length-1];
 if(!g) return;
 g.fields.pop();
 save();renderForm();
}

/* FORM */
function renderForm(){
 if(!currentArea){form.innerHTML="ì˜ì—­ ì„ íƒ";return;}
 form.innerHTML=currentArea.groups.map(g=>`
   <div class="group-title">${g.name}</div>
   ${g.fields.map(f=>`<textarea data-field="${g.id}-${f.id}" placeholder="${f.name}"></textarea>`).join("")}
`).join("")+`<button onclick="saveRecord()">ê¸°ë¡ ì €ì¥</button>`;
}

/* SAVE / EDIT */
function saveRecord(){
let values={};
document.querySelectorAll("[data-field]").forEach(i=>values[i.dataset.field]=i.value);
if(editingRecord){editingRecord.values=values;editingRecord=null;}
else{currentArea.records.unshift({id:Date.now(),values});}
save();renderRecords();renderForm();
}

function editRecord(id){
editingRecord=currentArea.records.find(r=>r.id===id);
Object.entries(editingRecord.values).forEach(([k,v])=>{
const el=document.querySelector(`[data-field="${k}"]`);
if(el)el.value=v;
});
window.scrollTo({top:0,behavior:"smooth"});
}

function deleteRecord(id){
if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
currentArea.records=currentArea.records.filter(r=>r.id!==id);
save();renderRecords();
}

/* RECORD LIST */
function renderRecords(){
if(!currentArea){records.innerHTML="";return;}
records.innerHTML=currentArea.records.map(r=>{
const firstValue=Object.values(r.values)[0]||"ê¸°ë¡";
return `<button onclick="toggleDetail(${r.id})">${firstValue}</button>
   <div class="record" id="detail-${r.id}" style="display:none">
     ${Object.entries(r.values).map(([k,v])=>{
       const [gid,fid]=k.split("-");
       const field=currentArea.groups.find(gr=>gr.id==gid)?.fields.find(ff=>ff.id==fid);
       return `<div><span class="record-field-name">${field?.name}</span><br>${v}</div>`;
     }).join("")}
     <button onclick="editRecord(${r.id})">ìˆ˜ì •</button>
     <button class="secondary" onclick="deleteRecord(${r.id})">ì‚­ì œ</button>
   </div>`;
 }).join("");
}

function toggleDetail(id){
const el=document.getElementById("detail-"+id);
el.style.display=el.style.display==="none"?"block":"none";
}

function renderAreas(){areaBar.innerHTML=db.areas.map(a=>`<div class="area-btn ${currentArea?.id===a.id?"active":""}" onclick="selectArea(${a.id})">${a.name}</div>`).join("");}

/* GITHUB */
async function upload(){
if(!token) return alert("í† í° ì…ë ¥ í•„ìš”");
const url=`https://api.github.com/repos/${GITHUB.user}/${GITHUB.repo}/contents/${GITHUB.path}`;
const content=btoa(unescape(encodeURIComponent(JSON.stringify(db,null,2))));
let sha=null;
const res=await fetch(url,{headers:{Authorization:"token "+token}});
if(res.ok){const json=await res.json();sha=json.sha;}
await fetch(url,{method:"PUT",headers:{Authorization:"token "+token},body:JSON.stringify({message:"update",content,sha})});
alert("ì—…ë¡œë“œ ì™„ë£Œ");
token="";
}

async function download(){
if(!token) return alert("í† í° ì…ë ¥ í•„ìš”");
const url=`https://api.github.com/repos/${GITHUB.user}/${GITHUB.repo}/contents/${GITHUB.path}`;
const res=await fetch(url,{headers:{Authorization:"token "+token}});
const json=await res.json();
db=JSON.parse(decodeURIComponent(escape(atob(json.content))));
save();renderAreas();renderRecords();
token="";
}

renderAreas();
</script>
</body>
</html>
