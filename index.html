<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Record App Core Stable</title>

<style>
:root{
  --bg:#f2f2f7;
  --card:#fff;
  --text:#111;
  --sub:#6b7280;
  --border:#e5e7eb;
  --accent:#007aff;
  --ios-orange:#FF9F0A;
}
.dark{
  --bg:#0b1220;
  --card:#111827;
  --text:#e5e7eb;
  --border:#1f2937;
}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system}
.container{max-width:950px;margin:auto;padding:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px}
.area-bar{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap}
.area-btn{padding:6px 12px;border-radius:12px;border:1px solid var(--border);cursor:pointer;background:#f1f3f5}
.area-btn.active{background:var(--accent);color:#fff;border:none}
input,textarea{width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;margin-bottom:6px;background:transparent;color:var(--text)}
button{border:none;background:var(--accent);color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}
.secondary{background:#9ca3af}
.record{border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:8px}
.group-title{font-size:13px;color:var(--sub);margin-top:8px;font-weight:600}
.select-row{display:flex;gap:6px}
.select-row button{flex:1}
.record-field-name{color:var(--ios-orange);font-weight:600}

/* modal */
.modal{
 position:fixed; inset:0; background:rgba(0,0,0,.4);
 display:none; align-items:center; justify-content:center;
}
.modal-box{
 background:#fff; padding:20px; border-radius:14px; width:300px;
}
.dark .modal-box{background:#111827}
</style>
</head>

<body>
<div class="container">

<button onclick="toggleDark()">ğŸŒ™ ë‹¤í¬ëª¨ë“œ</button>
<button onclick="openTokenModal()">GitHub í† í° ì…ë ¥</button>

<div class="area-bar" id="areaBar"></div>

<div class="card">
<b>ì˜ì—­ ê´€ë¦¬</b>
<input id="areaInput" placeholder="ì˜ì—­ ì´ë¦„">
<div class="select-row">
<button onclick="addArea()">ì¶”ê°€</button>
<button class="secondary" onclick="updateArea()">ìˆ˜ì •</button>
<button class="secondary" onclick="deleteArea()">ì‚­ì œ</button>
</div>
</div>

<div class="card">
<b>í•„ë“œ ê·¸ë£¹ ê´€ë¦¬</b>
<input id="groupInput" placeholder="ê·¸ë£¹ ì´ë¦„">
<div class="select-row">
<button onclick="addGroup()">ì¶”ê°€</button>
<button class="secondary" onclick="updateGroup()">ìˆ˜ì •</button>
<button class="secondary" onclick="deleteGroup()">ì‚­ì œ</button>
</div>
</div>

<div class="card">
<b>í•„ë“œ ê´€ë¦¬</b>
<input id="fieldInput" placeholder="í•„ë“œ ì´ë¦„">
<div class="select-row">
<button onclick="addField()">ì¶”ê°€</button>
<button class="secondary" onclick="updateField()">ìˆ˜ì •</button>
<button class="secondary" onclick="deleteField()">ì‚­ì œ</button>
</div>
</div>

<div class="card" id="form"></div>
<div id="records"></div>

<div class="card">
<b>GitHub ë™ê¸°í™”</b>
<button onclick="upload()">ì—…ë¡œë“œ</button>
<button class="secondary" onclick="download()">ë‹¤ìš´ë¡œë“œ</button>
</div>

</div>

<!-- TOKEN MODAL -->
<div class="modal" id="tokenModal">
  <div class="modal-box">
    <b>GitHub í† í° ì…ë ¥</b>
    <input id="tokenInput" placeholder="í† í° ì…ë ¥">
    <button onclick="setToken()">í™•ì¸</button>
  </div>
</div>

<script>
const GITHUB={user:"apor76-cmyk",repo:"data",path:"data/dailycheck.json"};

let db=JSON.parse(localStorage.getItem("recordDB")||'{"areas":[]}');
let currentArea=null,currentGroup=null,currentField=null,editingRecord=null;
let token=""; // ë©”ëª¨ë¦¬ ì €ì¥

const save=()=>localStorage.setItem("recordDB",JSON.stringify(db));
function toggleDark(){document.body.classList.toggle("dark")}

/* TOKEN */
function openTokenModal(){tokenModal.style.display="flex"}
function setToken(){token=tokenInput.value.trim();tokenModal.style.display="none";}

/* AREA */
function addArea(){if(!areaInput.value)return;db.areas.push({id:Date.now(),name:areaInput.value,groups:[],records:[]});areaInput.value="";save();renderAreas();}
function selectArea(id){currentArea=db.areas.find(a=>a.id===id);renderAreas();renderForm();renderRecords();}
function updateArea(){if(currentArea&&areaInput.value){currentArea.name=areaInput.value;save();renderAreas();}}
function deleteArea(){if(!currentArea)return;db.areas=db.areas.filter(a=>a!==currentArea);currentArea=null;save();renderAreas();renderForm();renderRecords();}

/* GROUP */
function addGroup(){if(!currentArea||!groupInput.value)return;currentArea.groups.push({id:Date.now(),name:groupInput.value,fields:[]});groupInput.value="";save();renderForm();}
function selectGroup(id){currentGroup=currentArea.groups.find(g=>g.id===id);groupInput.value=currentGroup.name;}
function updateGroup(){if(currentGroup&&groupInput.value){currentGroup.name=groupInput.value;save();renderForm();}}
function deleteGroup(){if(!currentGroup)return;currentArea.groups=currentArea.groups.filter(g=>g!==currentGroup);currentGroup=null;save();renderForm();}

/* FIELD */
function addField(){if(!currentGroup||!fieldInput.value)return;currentGroup.fields.push({id:Date.now(),name:fieldInput.value});fieldInput.value="";save();renderForm();}
function selectField(id){currentField=currentGroup.fields.find(f=>f.id===id);fieldInput.value=currentField.name;}
function updateField(){if(currentField&&fieldInput.value){currentField.name=fieldInput.value;save();renderForm();}}
function deleteField(){if(!currentField)return;currentGroup.fields=currentGroup.fields.filter(f=>f!==currentField);currentField=null;save();renderForm();}

/* FORM */
function renderForm(){
 if(!currentArea){form.innerHTML="ì˜ì—­ ì„ íƒ";return;}
 form.innerHTML=currentArea.groups.map(g=>`
   <div class="group-title" onclick="selectGroup(${g.id})">${g.name}</div>
   ${g.fields.map(f=>`<textarea data-field="${g.id}-${f.id}" placeholder="${f.name}" onclick="selectField(${f.id})"></textarea>`).join("")}
 `).join("")+`<button onclick="saveRecord()">ê¸°ë¡ ì €ì¥</button>`;
}

/* RECORD SAVE */
function saveRecord(){
 let values={};
 document.querySelectorAll("[data-field]").forEach(i=>values[i.dataset.field]=i.value);
 if(editingRecord){editingRecord.values=values;editingRecord=null;}
 else{currentArea.records.unshift({id:Date.now(),values});}
 save();renderRecords();renderForm();
}

/* RECORD LIST = ë²„íŠ¼ */
function renderRecords(){
 if(!currentArea){records.innerHTML="";return;}
 records.innerHTML=currentArea.records.map(r=>{
   const firstVal=Object.values(r.values)[0]||"ê¸°ë¡";
   return `
   <button onclick="toggleRecord(${r.id})">${firstVal}</button>
   <div id="rec-${r.id}" style="display:none" class="record">
     ${renderRecordDetail(r)}
     <button onclick="editRecord(${r.id})">ìˆ˜ì •</button>
     <button class="secondary" onclick="deleteRecord(${r.id})">ì‚­ì œ</button>
   </div>`;
 }).join("");
}

function renderRecordDetail(r){
 let grouped={};
 Object.entries(r.values).forEach(([k,v])=>{
   const [gid,fid]=k.split("-");
   if(!grouped[gid])grouped[gid]=[];
   grouped[gid].push({fid,value:v});
 });
 return Object.entries(grouped).map(([gid,fields])=>{
   const g=currentArea.groups.find(x=>x.id==gid);
   return `<div class="group-title">${g?.name||""}</div>
   ${fields.map(f=>{
     const field=currentArea.groups.find(gr=>gr.id==gid).fields.find(ff=>ff.id==f.fid);
     return `<div><span class="record-field-name">${field?.name}</span><br>${f.value}</div>`;
   }).join("")}`;
 }).join("");
}

function toggleRecord(id){
 const el=document.getElementById("rec-"+id);
 el.style.display=el.style.display==="none"?"block":"none";
}

function editRecord(id){editingRecord=currentArea.records.find(r=>r.id===id);Object.entries(editingRecord.values).forEach(([k,v])=>{const el=document.querySelector(`[data-field="${k}"]`);if(el)el.value=v;});}
function deleteRecord(id){currentArea.records=currentArea.records.filter(r=>r.id!==id);save();renderRecords();}

/* AREA RENDER */
function renderAreas(){areaBar.innerHTML=db.areas.map(a=>`<div class="area-btn ${currentArea?.id===a.id?"active":""}" onclick="selectArea(${a.id})">${a.name}</div>`).join("");}

/* GITHUB */
async function upload(){
 if(!token) return alert("í† í° ì…ë ¥ í•„ìš”");
 const url=`https://api.github.com/repos/${GITHUB.user}/${GITHUB.repo}/contents/${GITHUB.path}`;
 const content=btoa(unescape(encodeURIComponent(JSON.stringify(db,null,2))));
 let sha=null;
 const res=await fetch(url,{headers:{Authorization:"token "+token}});
 if(res.ok){const json=await res.json();sha=json.sha;}
 await fetch(url,{method:"PUT",headers:{Authorization:"token "+token},body:JSON.stringify({message:"update",content,sha})});
 alert("ì—…ë¡œë“œ ì™„ë£Œ");
}

async function download(){
 if(!token) return alert("í† í° ì…ë ¥ í•„ìš”");
 const url=`https://api.github.com/repos/${GITHUB.user}/${GITHUB.repo}/contents/${GITHUB.path}`;
 const res=await fetch(url,{headers:{Authorization:"token "+token}});
 const json=await res.json();
 db=JSON.parse(decodeURIComponent(escape(atob(json.content))));
 save();renderAreas();renderRecords();
}

renderAreas();
</script>
</body>
</html>
